<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NWS Watches & Warnings Dashboard</title>
<style>
body {
  background: #0b0b0b;
  color: #fff;
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  margin: 0;
  padding: 0;
}
h1 { margin: 1rem 0 0.5rem; font-size: 1.8rem; }
#zip { padding: 6px; border-radius: 5px; border: none; width: 100px; margin-right: 6px; }
button { padding: 6px 10px; border-radius: 5px; border: none; cursor: pointer; background: orange; color: black; font-weight: bold; }
.boxContainer { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
.box { background: #111; color: white; border-radius: 10px; padding: 15px; width: 260px; box-shadow: 0 0 8px rgba(0,0,0,0.6); }
.box h2 { margin-top: 0; }
.iconBar { display: flex; justify-content: space-around; flex-wrap: nowrap; margin: 10px 0; }
.icon-container { position: relative; display: inline-block; }
.alert-icon { width: 60px; height: 60px; opacity: 0.25; transition: all 0.3s ease; filter: drop-shadow(0 0 2px #000); }
.alert-icon.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 15px 4px rgba(255,165,0,0.6); border-radius: 10px; }
.alert-icon:hover { cursor: pointer; transform: scale(1.1); filter: brightness(1.3); }
.badge { position: absolute; top: -5px; right: -5px; background: orange; color: black; font-size: 12px; font-weight: bold; width: 18px; height: 18px; text-align: center; line-height: 18px; border-radius: 50%; box-shadow: 0 0 4px #000; pointer-events: none; display: none; }
#radarContainer { margin: 10px auto; width: 95%; max-width: 900px; }
iframe { width: 100%; height: 500px; border: none; border-radius: 10px; }
#alerts { max-width: 900px; margin: 20px auto; text-align: left; }
.alert { background: #1a1a1a; border-left: 5px solid orange; margin-bottom: 12px; padding: 12px; border-radius: 8px; }
.alert.watch { border-color: #00bfff; }
.alert.warning { border-color: #ff4500; }
.alert.advisory { border-color: #ffff66; }
html { scroll-behavior: smooth; }
small { color: #aaa; }
</style>
</head>
<body>

<h1>⚠️ NWS Watch & Warning Monitor</h1>
<div>
  <input id="zip" type="text" placeholder="ZIP" value="76088"/>
  <button onclick="manualLoad()">Load</button>
</div>

<div class="boxContainer">
  <div class="box" id="watchBox">
    <h2>Watches</h2>
    <div class="iconBar" id="watchIcons">
      <div class="icon-container">
        <svg class="alert-icon" id="watch-thunderstorm" data-alerttype="thunderstorm" title="Thunderstorm Watch: conditions favorable for thunderstorms" viewBox="0 0 64 64">
          <ellipse cx="32" cy="28" rx="20" ry="12" fill="lightblue"/>
          <polygon points="30,38 36,38 32,50 38,50 28,64 32,52 26,52" fill="orange"/>
        </svg>
        <div class="badge" id="badge-watch-thunderstorm">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="watch-tornado" data-alerttype="tornado" title="Tornado Watch: tornadoes possible" viewBox="0 0 64 64">
          <path d="M16 12 H48 L32 52 Z" fill="gray"/>
        </svg>
        <div class="badge" id="badge-watch-tornado">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="watch-flood" data-alerttype="flood" title="Flood Watch: flooding possible" viewBox="0 0 64 64">
          <path d="M10,50 Q20,45 30,50 T50,50" fill="none" stroke="deepskyblue" stroke-width="4"/>
        </svg>
        <div class="badge" id="badge-watch-flood">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="watch-winter" data-alerttype="winter" title="Winter Storm Watch: snow/ice possible" viewBox="0 0 64 64">
          <text x="16" y="40" font-size="32" fill="lightblue">❄️</text>
        </svg>
        <div class="badge" id="badge-watch-winter">0</div>
      </div>
    </div>
  </div>

  <div class="box" id="warningBox">
    <h2>Warnings</h2>
    <div class="iconBar" id="warningIcons">
      <div class="icon-container">
        <svg class="alert-icon" id="warning-thunderstorm" data-alerttype="thunderstorm" title="Severe Thunderstorm Warning: thunderstorms occurring" viewBox="0 0 64 64">
          <ellipse cx="32" cy="28" rx="20" ry="12" fill="lightblue"/>
          <polygon points="30,38 36,38 32,50 38,50 28,64 32,52 26,52" fill="orange"/>
        </svg>
        <div class="badge" id="badge-warning-thunderstorm">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="warning-tornado" data-alerttype="tornado" title="Tornado Warning: tornado occurring" viewBox="0 0 64 64">
          <path d="M16 12 H48 L32 52 Z" fill="red"/>
        </svg>
        <div class="badge" id="badge-warning-tornado">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="warning-flood" data-alerttype="flood" title="Flood Warning: flooding occurring" viewBox="0 0 64 64">
          <path d="M10,50 Q20,45 30,50 T50,50" fill="none" stroke="deepskyblue" stroke-width="4"/>
        </svg>
        <div class="badge" id="badge-warning-flood">0</div>
      </div>
      <div class="icon-container">
        <svg class="alert-icon" id="warning-winter" data-alerttype="winter" title="Winter Storm Warning: snow/ice occurring" viewBox="0 0 64 64">
          <text x="16" y="40" font-size="32" fill="lightblue">❄️</text>
        </svg>
        <div class="badge" id="badge-warning-winter">0</div>
      </div>
    </div>
  </div>
</div>

<div id="radarContainer">
  <iframe id="windyRadar" src="" ></iframe>
</div>

<div id="alerts"><p>Loading alerts...</p></div>
<p id="lastUpdated"></p>

<audio id="chime" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>
const POLL_INTERVAL_MINUTES = 1;
let previousAlertIds = new Set();
let currentLat = null;
let currentLon = null;

// Utility to fetch lat/lon from ZIP
async function getLatLonFromZip(zip) {
  const geo = await fetch(`https://api.zippopotam.us/us/${zip}`);
  const data = await geo.json();
  const { latitude, longitude } = data.places[0];
  return { lat: latitude, lon: longitude };
}

function playChime() { document.getElementById("chime").play().catch(()=>{}); }

// Update badges and icon highlighting
function updateBoxes(features){
  const counts = {
    'watch-thunderstorm':0, 'watch-tornado':0, 'watch-flood':0, 'watch-winter':0,
    'warning-thunderstorm':0, 'warning-tornado':0, 'warning-flood':0, 'warning-winter':0
  };
  let winterActive=false;

  features.forEach(f=>{
    const ev=f.properties.event.toLowerCase();
    if(ev.includes("watch")){
      if(ev.includes("thunderstorm")) counts['watch-thunderstorm']++;
      if(ev.includes("tornado")) counts['watch-tornado']++;
      if(ev.includes("flood")) counts['watch-flood']++;
      if(ev.includes("winter")||ev.includes("snow")||ev.includes("ice")) counts['watch-winter']++;
    }
    if(ev.includes("warning")){
      if(ev.includes("thunderstorm")) counts['warning-thunderstorm']++;
      if(ev.includes("tornado")) counts['warning-tornado']++;
      if(ev.includes("flood")) counts['warning-flood']++;
      if(ev.includes("winter")||ev.includes("snow")||ev.includes("ice")) counts['warning-winter']++;
    }
    if(ev.includes("winter")||ev.includes("snow")||ev.includes("ice")) winterActive=true;
  });

  Object.keys(counts).forEach(id=>{
    const icon = document.getElementById(id);
    const badge = document.getElementById("badge-"+id);
    if(counts[id]>0){
      icon.classList.add("active");
      badge.textContent=counts[id];
      badge.style.display="block";
    } else {
      icon.classList.remove("active");
      badge.textContent="0";
      badge.style.display="none";
    }
  });

  // Update Windy overlay
  if(currentLat && currentLon){
    let overlay = winterActive ? "snow" : "radar";
    document.getElementById("windyRadar").src =
      `https://embed.windy.com/embed2.html?lat=${currentLat}&lon=${currentLon}&zoom=8&level=surface&overlay=${overlay}&menu=&message=true&marker=true`;
  }
}

// Load alerts for given lat/lon
async function loadAlertsByLatLon(lat, lon){
  currentLat=lat;
  currentLon=lon;
  const alertsContainer=document.getElementById("alerts");
  const lastUpdated=document.getElementById("lastUpdated");
  alertsContainer.innerHTML="Loading alerts...";

  try {
    const alertRes = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`);
    const data = await alertRes.json();
    alertsContainer.innerHTML="";

    if(!data.features || data.features.length===0){
      alertsContainer.textContent="✅ No active watches, warnings, or advisories.";
      lastUpdated.textContent=`Last updated: ${new Date().toLocaleTimeString()}`;
      previousAlertIds.clear();
      updateBoxes([]);
      return;
    }

    const newIds=new Set(data.features.map(f=>f.id));
    let newAlertDetected=false;

    data.features.forEach(alert=>{
      const props = alert.properties;
      const id = props.event.toLowerCase().replace(/\s+/g,'-');
      const div=document.createElement("div");
      div.className="alert";
      if(props.event.toLowerCase().includes("watch")) div.classList.add("watch");
      if(props.event.toLowerCase().includes("warning")) div.classList.add("warning");
      if(props.event.toLowerCase().includes("advisory")) div.classList.add("advisory");
      div.id=id;
      div.innerHTML=`
        <h2>${props.event}</h2>
        <p><strong>${props.headline||""}</strong></p>
        <p>${props.description?props.description.replace(/\n/g,"<br>"):""}</p>
        <small>
          <strong>Effective:</strong> ${props.effective?new Date(props.effective).toLocaleString():"N/A"}<br>
          <strong>Expires:</strong> ${props.expires?new Date(props.expires).toLocaleString():"N/A"}
        </small>`;
      alertsContainer.appendChild(div);
      if(!previousAlertIds.has(alert.id)) newAlertDetected=true;
    });

    updateBoxes(data.features);
    if(newAlertDetected) playChime();
    previousAlertIds=newIds;
    lastUpdated.textContent=`Last updated: ${new Date().toLocaleTimeString()}`;
  } catch(err){
    console.warn("NWS alert fetch error:", err.message);
    alertsContainer.textContent="No current alerts at this time.";
    lastUpdated.textContent=`Last updated: ${new Date().toLocaleTimeString()}`;
    updateBoxes([]);
  }
}

// Manual load from ZIP
async function manualLoad(){
  const zip=document.getElementById("zip").value.trim();
  if(!zip) return;
  try{
    const {lat, lon}=await getLatLonFromZip(zip);
    loadAlertsByLatLon(lat, lon);
  }catch(e){
    alert("Invalid ZIP or network error.");
  }
}

// On page load: try geolocation
window.addEventListener("load", ()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude}=pos.coords;
      loadAlertsByLatLon(latitude, longitude);
    }, ()=>{
      // fallback to ZIP
      manualLoad();
    });
  } else {
    manualLoad();
  }
});

// Icon click scroll behavior
document.addEventListener("click", e=>{
  if(e.target.closest(".alert-icon")){
    const targetType=e.target.closest(".alert-icon").dataset.alerttype;
    const target=document.getElementById(targetType);
    if(target) target.scrollIntoView({behavior:"smooth"});
  }
});

// Poll every minute
setInterval(()=>{ 
  if(currentLat && currentLon) loadAlertsByLatLon(currentLat, currentLon);
}, POLL_INTERVAL_MINUTES*60*1000);

</script>
</body>
</html>
